<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Kanji-Raster Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/styles.css">



    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="kanjiLogo"></div>

    <!-- <h1 id="mainTitelKana">カンジラスタージェネレーター</h1> -->

    <div class="form-container">
        <div class="input-group">
            <label>Kanji:
                <input type="text" id="kanjiInput" placeholder="魚">
            </label>
            <label>Romaji:
                <input type="text" id="romajiInput" placeholder="sakana">
            </label>
            <label>Kun:
                <input type="text" id="kunInput" placeholder="さかな">
            </label>
            <label>On:
                <input type="text" id="onInput" placeholder="ギョ">
            </label>
        </div>


        <div class="button-group">

            <button onclick="fillSVG()"><svg class="icon white" xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor"
                    viewBox="0 0 256 256">
                    <path
                        d="M229.66,58.34l-32-32a8,8,0,0,0-11.32,0l-96,96A8,8,0,0,0,88,128v32a8,8,0,0,0,8,8h32a8,8,0,0,0,5.66-2.34l96-96A8,8,0,0,0,229.66,58.34ZM124.69,152H104V131.31l64-64L188.69,88ZM200,76.69,179.31,56,192,43.31,212.69,64ZM224,128v80a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h80a8,8,0,0,1,0,16H48V208H208V128a8,8,0,0,1,16,0Z">
                    </path>
                </svg>Eintragen <i class="ph ph-printer"></i> </button>

            <button onclick="downloadPDF()"><svg class="icon white" xmlns="http://www.w3.org/2000/svg" width="32"
                    height="32" fill="currentColor" viewBox="0 0 256 256">
                    <path
                        d="M224,152a8,8,0,0,1-8,8H192v16h16a8,8,0,0,1,0,16H192v16a8,8,0,0,1-16,0V152a8,8,0,0,1,8-8h32A8,8,0,0,1,224,152ZM92,172a28,28,0,0,1-28,28H56v8a8,8,0,0,1-16,0V152a8,8,0,0,1,8-8H64A28,28,0,0,1,92,172Zm-16,0a12,12,0,0,0-12-12H56v24h8A12,12,0,0,0,76,172Zm88,8a36,36,0,0,1-36,36H112a8,8,0,0,1-8-8V152a8,8,0,0,1,8-8h16A36,36,0,0,1,164,180Zm-16,0a20,20,0,0,0-20-20h-8v40h8A20,20,0,0,0,148,180ZM40,112V40A16,16,0,0,1,56,24h96a8,8,0,0,1,5.66,2.34l56,56A8,8,0,0,1,216,88v24a8,8,0,0,1-16,0V96H152a8,8,0,0,1-8-8V40H56v72a8,8,0,0,1-16,0ZM160,80h28.69L160,51.31Z">
                    </path>
                </svg>Als PDF speichern</button>

            <button onclick="printPDF()"> <svg class="icon white" xmlns="http://www.w3.org/2000/svg" width="32"
                    height="32" fill="currentColor" viewBox="0 0 256 256">
                    <path
                        d="M214.67,72H200V40a8,8,0,0,0-8-8H64a8,8,0,0,0-8,8V72H41.33C27.36,72,16,82.77,16,96v80a8,8,0,0,0,8,8H56v32a8,8,0,0,0,8,8H192a8,8,0,0,0,8-8V184h32a8,8,0,0,0,8-8V96C240,82.77,228.64,72,214.67,72ZM72,48H184V72H72ZM184,208H72V160H184Zm40-40H200V152a8,8,0,0,0-8-8H64a8,8,0,0,0-8,8v16H32V96c0-4.41,4.19-8,9.33-8H214.67c5.14,0,9.33,3.59,9.33,8Zm-24-52a12,12,0,1,1-12-12A12,12,0,0,1,200,116Z">
                    </path>
                </svg>Drucken</button>

            <button onclick="addNewTable()"><svg class="icon white" xmlns="http://www.w3.org/2000/svg" width="32"
                    height="32" fill="currentColor" viewBox="0 0 256 256">
                    <path
                        d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z">
                    </path>
                </svg>Neue Tabelle</button>

        </div>

        <div class="select-group">
            <label for="tableSelector">Aktive Tabelle:
                <select id="tableSelector"></select>
            </label>
        </div>



        <div id="svg-pages">
            <!-- Hier erscheinen mehrere SVGs -->
        </div>
    </div>
    <div id="footer-container">
        <footer>
            <p>© PixSez Designs 2023</p>
        </footer>

    </div>



    <script>

        let svgTemplateText = "";
        let svgLoaded = false;

        // SVG einmalig laden
        fetch('KanjiRaster.svg')
            .then(response => response.text())
            .then(data => {
                svgTemplateText = data;
                svgLoaded = true;
                addNewTable(); // erste Tabelle automatisch laden
            });

        const logoDiv = document.getElementById("kanjiLogo");

        const img = document.createElement("img");
        img.src = "kanjiLogo.svg";
        img.alt = "Kanji Logo";
        img.style.width = "500px"; // Optional: Breite anpassen
        img.style.height = "auto"; // Höhe automatisch
        img.style.display = "block"; // Optional: Block-Element für bessere Zentrierung
        img.style.margin = "0 auto"; // Optional: Zentrieren

        logoDiv.appendChild(img);



        // function addNewTable() {
        //     if (!svgLoaded) return;

        //     const container = document.getElementById("svg-pages");
        //     const wrapper = document.createElement("div");
        //     wrapper.classList.add("svg-container");
        //     wrapper.innerHTML = svgTemplateText;

        //     container.appendChild(wrapper);
        // }
        let tableCount = 0;

        function addNewTable() {
            if (!svgLoaded) return;

            const container = document.getElementById("svg-pages");
            const wrapper = document.createElement("div");
            wrapper.classList.add("svg-container");

            // Eindeutige ID für jede Tabelle
            const tableId = `table-${tableCount++}`;
            wrapper.dataset.tableId = tableId;

            wrapper.innerHTML = svgTemplateText;
            container.appendChild(wrapper);

            // Neue Option im Dropdown einfügen
            const selector = document.getElementById("tableSelector");
            const option = document.createElement("option");
            option.value = tableId;
            option.textContent = `Tabelle ${tableCount}`;
            selector.appendChild(option);

            // Neue Tabelle automatisch auswählen
            selector.value = tableId;
        }


        // function fillSVG() {
        //     if (!svgLoaded) {
        //         alert("Bitte warten – SVG wird noch geladen.");
        //         return;
        //     }

        //     const kanji = document.getElementById("kanjiInput").value;
        //     const on = document.getElementById("onInput").value;
        //     const kun = document.getElementById("kunInput").value;
        //     const romaji = document.getElementById("romajiInput").value;

        //     const ids = [
        //         ["MainKanji", kanji],
        //         ["OnLesung", on],
        //         ["KunLesung", kun],
        //         ["Romaji", romaji],
        //         ["Kanjitr", kanji],
        //         ["Kanjitr1", kanji],
        //         ["Kanjitr2", kanji],
        //         ["Kanjitr3", kanji],
        //         ["Kanjitr4", kanji],
        //         ["Kanjitr5", kanji],
        //         ["Kanjitr6", kanji],
        //         ["Kanjitr7", kanji],
        //         ["Kanjitr8", kanji],
        //         ["Kanjitr9", kanji],
        //     ];

        //     // ⬇️ Nur das letzte SVG-Element befüllen
        //     const svgContainers = document.querySelectorAll(".svg-container");
        //     const lastContainer = svgContainers[svgContainers.length - 1]; // das zuletzt hinzugefügte

        //     ids.forEach(([id, value]) => {
        //         const el = lastContainer.querySelector(`#${id}`);
        //         if (el) el.textContent = value;
        //     });
        // }

        function fillSVG() {
            if (!svgLoaded) {
                alert("Bitte warten – SVG wird noch geladen.");
                return;
            }

            const selectedId = document.getElementById("tableSelector").value;
            const allTables = document.querySelectorAll(".svg-container");
            const selectedTable = Array.from(allTables).find(t => t.dataset.tableId === selectedId);

            if (!selectedTable) {
                alert("Keine gültige Tabelle ausgewählt.");
                return;
            }

            const kanji = document.getElementById("kanjiInput").value;
            const on = document.getElementById("onInput").value;
            const kun = document.getElementById("kunInput").value;
            const romaji = document.getElementById("romajiInput").value;

            const ids = [
                ["MainKanji", kanji],
                ["OnLesung", on],
                ["KunLesung", kun],
                ["Romaji", romaji],
                ["Kanjitr", kanji],
                ["Kanjitr1", kanji],
                ["Kanjitr2", kanji],
                ["Kanjitr3", kanji],
                ["Kanjitr4", kanji],
                ["Kanjitr5", kanji],
                ["Kanjitr6", kanji],
                ["Kanjitr7", kanji],
                ["Kanjitr8", kanji],
                ["Kanjitr9", kanji],
            ];

            ids.forEach(([id, value]) => {
                const el = selectedTable.querySelector(`#${id}`);
                if (el) el.textContent = value;
            });
        }


        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("portrait", "mm", "a4");

            const containers = document.querySelectorAll(".svg-container");

            const tablesPerPage = 5;
            const spacing = 5; // Abstand zwischen SVGs in mm
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 10;

            const usableHeight = pageHeight - 2 * margin - (spacing * (tablesPerPage - 1));
            const singleHeight = usableHeight / tablesPerPage;
            const usableWidth = pageWidth - 2 * margin;

            for (let i = 0; i < containers.length; i++) {
                const canvas = await html2canvas(containers[i], { useCORS: true });
                const imgData = canvas.toDataURL("image/png");

                const imgWidthMm = canvas.width * 0.2646;
                const imgHeightMm = canvas.height * 0.2646;

                // Verhältnis der Originalgröße beibehalten
                const scale = Math.min(usableWidth / imgWidthMm, singleHeight / imgHeightMm);
                const scaledWidth = imgWidthMm * scale;
                const scaledHeight = imgHeightMm * scale;

                const columnX = margin + (usableWidth - scaledWidth) / 2;
                const row = i % tablesPerPage;
                const columnY = margin + row * (scaledHeight + spacing);

                if (i > 0 && row === 0) {
                    pdf.addPage();
                }

                pdf.addImage(imgData, "PNG", columnX, columnY, scaledWidth, scaledHeight);
            }

            pdf.save("kanji-raster.pdf");
        }

        async function printPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("portrait", "mm", "a4");

            const containers = document.querySelectorAll(".svg-container");

            const tablesPerPage = 5;
            const spacing = 5; // Abstand zwischen SVGs in mm
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 10;

            const usableHeight = pageHeight - 2 * margin - (spacing * (tablesPerPage - 1));
            const singleHeight = usableHeight / tablesPerPage;
            const usableWidth = pageWidth - 2 * margin;

            for (let i = 0; i < containers.length; i++) {
                const canvas = await html2canvas(containers[i], { useCORS: true });
                const imgData = canvas.toDataURL("image/png");

                const imgWidthMm = canvas.width * 0.2646;
                const imgHeightMm = canvas.height * 0.2646;

                const scale = Math.min(usableWidth / imgWidthMm, singleHeight / imgHeightMm);
                const scaledWidth = imgWidthMm * scale;
                const scaledHeight = imgHeightMm * scale;

                const columnX = margin + (usableWidth - scaledWidth) / 2;
                const row = i % tablesPerPage;
                const columnY = margin + row * (scaledHeight + spacing);

                if (i > 0 && row === 0) {
                    pdf.addPage();
                }

                pdf.addImage(imgData, "PNG", columnX, columnY, scaledWidth, scaledHeight);
            }

            // PDF als Blob erzeugen
            const pdfBlob = pdf.output("blob");

            // URL für Blob erstellen
            const blobUrl = URL.createObjectURL(pdfBlob);

            // Neues Fenster / Tab öffnen mit PDF-Viewer und Druckdialog starten
            const printWindow = window.open(blobUrl);

            // Sobald das Fenster geladen ist, Druckdialog auslösen
            printWindow.onload = function () {
                printWindow.focus();
                printWindow.print();
            };
        }


    </script>
</body>

</html>