<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Kanji-Raster Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="kanjiLogo"></div>
    <!-- <h1 id="mainTitelKana">カンジラスタージェネレーター</h1> -->

    <div class="form-container">
        <div class="input-group">
          <label>Kanji:
            <input type="text" id="kanjiInput">
          </label>
          <label>Romaji:
            <input type="text" id="romajiInput">
          </label>
          <label>Kun:
            <input type="text" id="kunInput">
          </label>
          <label>On:
            <input type="text" id="onInput">
          </label>
        </div>
      
        <div class="button-group">
          <button onclick="fillSVG()">Eintragen</button>
          <button onclick="downloadPDF()">Als PDF speichern</button>
          <button onclick="window.print()">Drucken</button>
          <button onclick="addNewTable()">+ Neue Tabelle</button>
        </div>
      
        <div id="svg-pages">
          <!-- Hier erscheinen mehrere SVGs -->
        </div>
      </div>
      


    <script>
        let svgTemplateText = "";
        let svgLoaded = false;

        // SVG einmalig laden
        fetch('KanjiRaster.svg')
            .then(response => response.text())
            .then(data => {
                svgTemplateText = data;
                svgLoaded = true;
                addNewTable(); // erste Tabelle automatisch laden
            });

        const logoDiv = document.getElementById("kanjiLogo");

        const img = document.createElement("img");
        img.src = "kanjiLogo.svg";
        img.alt = "Kanji Logo";
        img.style.width = "500px"; // Optional: Breite anpassen
        img.style.height = "auto"; // Höhe automatisch
        img.style.display = "block"; // Optional: Block-Element für bessere Zentrierung
        img.style.margin = "0 auto"; // Optional: Zentrieren

        logoDiv.appendChild(img);



        function addNewTable() {
            if (!svgLoaded) return;

            const container = document.getElementById("svg-pages");
            const wrapper = document.createElement("div");
            wrapper.classList.add("svg-container");
            wrapper.innerHTML = svgTemplateText;

            container.appendChild(wrapper);
        }

        function fillSVG() {
            if (!svgLoaded) {
                alert("Bitte warten – SVG wird noch geladen.");
                return;
            }

            const kanji = document.getElementById("kanjiInput").value;
            const on = document.getElementById("onInput").value;
            const kun = document.getElementById("kunInput").value;
            const romaji = document.getElementById("romajiInput").value;

            const ids = [
                ["MainKanji", kanji],
                ["OnLesung", on],
                ["KunLesung", kun],
                ["Romaji", romaji],
                ["Kanjitr", kanji],
                ["Kanjitr1", kanji],
                ["Kanjitr2", kanji],
                ["Kanjitr3", kanji],
                ["Kanjitr4", kanji],
                ["Kanjitr5", kanji],
                ["Kanjitr6", kanji],
                ["Kanjitr7", kanji],
                ["Kanjitr8", kanji],
                ["Kanjitr9", kanji],
            ];

            // ⬇️ Nur das letzte SVG-Element befüllen
            const svgContainers = document.querySelectorAll(".svg-container");
            const lastContainer = svgContainers[svgContainers.length - 1]; // das zuletzt hinzugefügte

            ids.forEach(([id, value]) => {
                const el = lastContainer.querySelector(`#${id}`);
                if (el) el.textContent = value;
            });
        }


        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("portrait", "mm", "a4");

            const containers = document.querySelectorAll(".svg-container");

            const tablesPerPage = 5;
            const spacing = 5; // Abstand zwischen SVGs in mm
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 10;

            const usableHeight = pageHeight - 2 * margin - (spacing * (tablesPerPage - 1));
            const singleHeight = usableHeight / tablesPerPage;
            const usableWidth = pageWidth - 2 * margin;

            for (let i = 0; i < containers.length; i++) {
                const canvas = await html2canvas(containers[i], { useCORS: true });
                const imgData = canvas.toDataURL("image/png");

                const imgWidthMm = canvas.width * 0.2646;
                const imgHeightMm = canvas.height * 0.2646;

                // Verhältnis der Originalgröße beibehalten
                const scale = Math.min(usableWidth / imgWidthMm, singleHeight / imgHeightMm);
                const scaledWidth = imgWidthMm * scale;
                const scaledHeight = imgHeightMm * scale;

                const columnX = margin + (usableWidth - scaledWidth) / 2;
                const row = i % tablesPerPage;
                const columnY = margin + row * (scaledHeight + spacing);

                if (i > 0 && row === 0) {
                    pdf.addPage();
                }

                pdf.addImage(imgData, "PNG", columnX, columnY, scaledWidth, scaledHeight);
            }

            pdf.save("kanji-raster.pdf");
        }

    </script>
</body>

</html>