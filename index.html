<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Kanji-Raster Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/styles.css">



    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="kanjiLogo"></div>

    <!-- <h1 id="mainTitelKana">カンジラスタージェネレーター</h1> -->

    <div class="form-container">
        <div class="input-group">
            <label>Kanji:
                <input type="text" id="kanjiInput" placeholder="魚">
            </label>
            <label>Romaji:
                <input type="text" id="romajiInput" placeholder="sakana">
            </label>
            <label>Kun:
                <input type="text" id="kunInput" placeholder="さかな">
            </label>
            <label>On:
                <input type="text" id="onInput" placeholder="ギョ">
            </label>
        </div>


        <div class="button-group">

            <button onclick="fillSVG()" title="Tabelle mit ausgefüllten Feldern bespeißen"><svg class="icon white"
                    xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                    <path
                        d="M229.66,58.34l-32-32a8,8,0,0,0-11.32,0l-96,96A8,8,0,0,0,88,128v32a8,8,0,0,0,8,8h32a8,8,0,0,0,5.66-2.34l96-96A8,8,0,0,0,229.66,58.34ZM124.69,152H104V131.31l64-64L188.69,88ZM200,76.69,179.31,56,192,43.31,212.69,64ZM224,128v80a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h80a8,8,0,0,1,0,16H48V208H208V128a8,8,0,0,1,16,0Z">
                    </path>
                </svg>Eintragen <i class="ph ph-printer"></i> </button>

            <button onclick="downloadPDF()" title="PDF herunterladen"><svg class="icon white"
                    xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                    <path
                        d="M224,152a8,8,0,0,1-8,8H192v16h16a8,8,0,0,1,0,16H192v16a8,8,0,0,1-16,0V152a8,8,0,0,1,8-8h32A8,8,0,0,1,224,152ZM92,172a28,28,0,0,1-28,28H56v8a8,8,0,0,1-16,0V152a8,8,0,0,1,8-8H64A28,28,0,0,1,92,172Zm-16,0a12,12,0,0,0-12-12H56v24h8A12,12,0,0,0,76,172Zm88,8a36,36,0,0,1-36,36H112a8,8,0,0,1-8-8V152a8,8,0,0,1,8-8h16A36,36,0,0,1,164,180Zm-16,0a20,20,0,0,0-20-20h-8v40h8A20,20,0,0,0,148,180ZM40,112V40A16,16,0,0,1,56,24h96a8,8,0,0,1,5.66,2.34l56,56A8,8,0,0,1,216,88v24a8,8,0,0,1-16,0V96H152a8,8,0,0,1-8-8V40H56v72a8,8,0,0,1-16,0ZM160,80h28.69L160,51.31Z">
                    </path>
                </svg>Als PDF speichern</button>

            <button onclick="printPDF()" title="Dokument drucken"> <svg class="icon white"
                    xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                    <path
                        d="M214.67,72H200V40a8,8,0,0,0-8-8H64a8,8,0,0,0-8,8V72H41.33C27.36,72,16,82.77,16,96v80a8,8,0,0,0,8,8H56v32a8,8,0,0,0,8,8H192a8,8,0,0,0,8-8V184h32a8,8,0,0,0,8-8V96C240,82.77,228.64,72,214.67,72ZM72,48H184V72H72ZM184,208H72V160H184Zm40-40H200V152a8,8,0,0,0-8-8H64a8,8,0,0,0-8,8v16H32V96c0-4.41,4.19-8,9.33-8H214.67c5.14,0,9.33,3.59,9.33,8Zm-24-52a12,12,0,1,1-12-12A12,12,0,0,1,200,116Z">
                    </path>
                </svg>Drucken</button>

            <button onclick="addNewTable()" title="Weitere Tabelle hinzufügen"><svg class="icon white"
                    xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                    <path
                        d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z">
                    </path>
                </svg>Neue Tabelle</button>

            <button onclick="deleteTable()" title="Tabelle löschen"><svg class="icon white"
                    xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                    <path
                        d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96Zm96,168H64V64H192ZM112,104v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Z">
                    </path>
                </svg>
                </svg>Tabelle löschen</button>


        </div>
        <div class="fileUploudContainer">
            <label>Datei hochladen (XML oder Excel):
                <input type="file" id="fileInput" accept=".xml,.xlsx,.xls">
            </label>
            <button onclick="importFile()">Importieren</button>
        </div>

        <div class="select-group">
            <label for="tableSelector">Aktive Tabelle:
                <select id="tableSelector"></select>
            </label>
        </div>



        <div id="svg-pages">
            <!-- Hier erscheinen mehrere SVGs -->
        </div>
    </div>
    <div id="copyright">
        <footer>
            <p>© Skrollan Elena Hyodo</p>

        </footer>

    </div>


    <script>
        // ==============================
        // Globale Variablen & Initialisierung
        // ==============================
        let svgTemplateText = "";   // Vorlage für die SVG-Tabelle
        let svgLoaded = false;      // Status, ob die SVG-Datei geladen ist
        let tableCount = 0;         // Interner Zähler für eindeutige IDs
        const selector = document.getElementById("tableSelector"); // Dropdown für aktive Tabelle

        // ==============================
        // Logo einfügen
        // ==============================
        const logoDiv = document.getElementById("kanjiLogo");
        const img = document.createElement("img");
        img.src = "kanjiLogo.svg";
        img.alt = "Kanji Logo";
        img.style.width = "500px";
        img.style.height = "auto";
        img.style.display = "block";
        img.style.margin = "0 auto";
        logoDiv.appendChild(img);

        // ==============================
        // SVG laden
        // ==============================
        fetch('KanjiRaster.svg')
            .then(response => response.text())
            .then(data => {
                svgTemplateText = data;
                svgLoaded = true;
                addNewTable(); // Erste Tabelle automatisch erstellen
            });

        // ==============================
        // Tabelle verwalten
        // ==============================

        // Funktion: Aktive Tabelle markieren und scrollen
        function markActiveTable() {
            const selectedId = selector.value;
            const allTables = document.querySelectorAll(".svg-container");

            allTables.forEach(table => {
                if (table.dataset.tableId === selectedId) {
                    table.classList.add("active");
                    table.scrollIntoView({ behavior: "smooth", block: "center" });
                } else {
                    table.classList.remove("active");
                }
            });
        }

        // Event Listener für Dropdown-Änderung
        selector.addEventListener("change", markActiveTable);

        // Funktion: Neue Tabelle hinzufügen
        function addNewTable() {
            if (!svgLoaded) return;

            const container = document.getElementById("svg-pages");
            const wrapper = document.createElement("div");
            wrapper.classList.add("svg-container");

            const tableId = `table-${tableCount++}`; // interne ID bleibt eindeutig
            wrapper.dataset.tableId = tableId;
            wrapper.innerHTML = svgTemplateText;

            container.appendChild(wrapper);

            updateTableSelector();       // Dropdown aktualisieren
            selector.value = tableId;    // Neue Tabelle automatisch auswählen
            markActiveTable();           // Aktiv markieren
        }

        // Funktion: Dropdown dynamisch aktualisieren
        function updateTableSelector() {
            const tables = document.querySelectorAll(".svg-container");
            selector.innerHTML = ''; // alte Optionen löschen

            tables.forEach((table, index) => {
                const option = document.createElement("option");
                option.value = table.dataset.tableId;
                option.textContent = `Tabelle ${index + 1}`; // Nummerierung dynamisch
                selector.appendChild(option);
            });
        }

        // Funktion: Tabelle löschen
        function deleteTable() {
            const selectedId = selector.value;
            const tableToDelete = document.querySelector(`.svg-container[data-table-id="${selectedId}"]`);
            const optionToDelete = selector.querySelector(`option[value="${selectedId}"]`);

            if (tableToDelete && optionToDelete) {
                tableToDelete.remove();
                optionToDelete.remove();
            }

            // Neue Auswahl festlegen
            if (selector.options.length > 0) {
                selector.value = selector.options[0].value;
            } else {
                addNewTable(); // Falls keine Tabelle übrig, neue erstellen
            }

            markActiveTable();
        }

        // ==============================
        // Tabelle mit Input füllen
        // ==============================
        function fillSVG() {
            if (!svgLoaded) {
                alert("Bitte warten – SVG wird noch geladen.");
                return;
            }

            const selectedId = selector.value;
            const allTables = document.querySelectorAll(".svg-container");
            const selectedTable = Array.from(allTables).find(t => t.dataset.tableId === selectedId);

            if (!selectedTable) {
                alert("Keine gültige Tabelle ausgewählt.");
                return;
            }

            // Werte aus Input-Feldern holen
            const kanji = document.getElementById("kanjiInput").value;
            const on = document.getElementById("onInput").value;
            const kun = document.getElementById("kunInput").value;
            const romaji = document.getElementById("romajiInput").value;

            // IDs in SVG, die befüllt werden
            const ids = [
                ["MainKanji", kanji],
                ["OnLesung", on],
                ["KunLesung", kun],
                ["Romaji", romaji],
                ["Kanjitr", kanji],
                ["Kanjitr1", kanji],
                ["Kanjitr2", kanji],
                ["Kanjitr3", kanji],
                ["Kanjitr4", kanji],
                ["Kanjitr5", kanji],
                ["Kanjitr6", kanji],
                ["Kanjitr7", kanji],
                ["Kanjitr8", kanji],
                ["Kanjitr9", kanji],
            ];

            ids.forEach(([id, value]) => {
                const el = selectedTable.querySelector(`#${id}`);
                if (el) el.textContent = value;
            });
        }

        // ==============================
        // PDF Export / Drucken
        // ==============================
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("portrait", "mm", "a4");

            // Temporär Hervorhebung entfernen
            const activeEl = document.querySelector(".svg-container.active");
            if (activeEl) activeEl.classList.remove("active");

            const containers = document.querySelectorAll(".svg-container");
            const tablesPerPage = 5;
            const spacing = 5;
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 10;

            const usableHeight = pageHeight - 2 * margin - (spacing * (tablesPerPage - 1));
            const singleHeight = usableHeight / tablesPerPage;
            const usableWidth = pageWidth - 2 * margin;

            for (let i = 0; i < containers.length; i++) {
                const canvas = await html2canvas(containers[i], { useCORS: true, scale: 2 });
                const imgData = canvas.toDataURL("image/png");

                const imgWidthMm = canvas.width * 0.2646;
                const imgHeightMm = canvas.height * 0.2646;
                const scale = Math.min(usableWidth / imgWidthMm, singleHeight / imgHeightMm);

                const scaledWidth = imgWidthMm * scale;
                const scaledHeight = imgHeightMm * scale;
                const columnX = margin + (usableWidth - scaledWidth) / 2;
                const row = i % tablesPerPage;
                const columnY = margin + row * (scaledHeight + spacing);

                if (i > 0 && row === 0) pdf.addPage();
                pdf.addImage(imgData, "PNG", columnX, columnY, scaledWidth, scaledHeight);
            }

            // Hervorhebung wiederherstellen
            if (activeEl) activeEl.classList.add("active");

            pdf.save("kanji-raster.pdf");
        }

        async function printPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("portrait", "mm", "a4");

            // Temporär Hervorhebung entfernen
            const activeEl = document.querySelector(".svg-container.active");
            if (activeEl) activeEl.classList.remove("active");

            const containers = document.querySelectorAll(".svg-container");
            const tablesPerPage = 5;
            const spacing = 5;
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 10;

            const usableHeight = pageHeight - 2 * margin - (spacing * (tablesPerPage - 1));
            const singleHeight = usableHeight / tablesPerPage;
            const usableWidth = pageWidth - 2 * margin;

            for (let i = 0; i < containers.length; i++) {
                const canvas = await html2canvas(containers[i], { useCORS: true, scale: 2 });
                const imgData = canvas.toDataURL("image/png");

                const imgWidthMm = canvas.width * 0.2646;
                const imgHeightMm = canvas.height * 0.2646;
                const scale = Math.min(usableWidth / imgWidthMm, singleHeight / imgHeightMm);

                const scaledWidth = imgWidthMm * scale;
                const scaledHeight = imgHeightMm * scale;
                const columnX = margin + (usableWidth - scaledWidth) / 2;
                const row = i % tablesPerPage;
                const columnY = margin + row * (scaledHeight + spacing);

                if (i > 0 && row === 0) pdf.addPage();
                pdf.addImage(imgData, "PNG", columnX, columnY, scaledWidth, scaledHeight);
            }

            // Hervorhebung wiederherstellen
            if (activeEl) activeEl.classList.add("active");

            const pdfBlob = pdf.output("blob");
            const blobUrl = URL.createObjectURL(pdfBlob);
            const printWindow = window.open(blobUrl);

            printWindow.onload = function () {
                printWindow.focus();
                printWindow.print();
            };
        }


        // ==============================
        // Input-Felder: Placeholder verschwinden beim Fokus
        // ==============================
        document.querySelectorAll('.input-group input[type="text"]').forEach(input => {
            const originalPlaceholder = input.placeholder;

            input.addEventListener('focus', () => {
                input.placeholder = '';
            });

            input.addEventListener('blur', () => {
                input.placeholder = originalPlaceholder;
            });
        });

        // ==============================
        // Datei importieren (XML oder Excel)
        // ==============================
        function importFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) {
                alert("Keine Datei ausgewählt!");
                return;
            }

            // Prüfen, ob die Datei ein unterstütztes Format ist
            const isExcelLike = file.name.endsWith(".xlsx") || file.name.endsWith(".xls") || file.name.endsWith(".xml");

            if (!isExcelLike) {
                alert("Nur Excel-Dateien (.xlsx, .xls) oder Excel-XML (.xml) werden unterstützt.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                // Datei als ArrayBuffer für SheetJS einlesen
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Erstes Tabellenblatt auslesen
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                // Falls die erste Zeile nur Überschriften enthält → bei Zeile 1 starten
                for (let i = 0; i < json.length; i++) {
                    const values = json[i];
                    if (!values || values.length === 0) continue; // Überspringen, wenn leer

                    // Neue Tabelle anlegen
                    addNewTable();
                    selector.value = selector.options[selector.options.length - 1].value;

                    // Input-Felder befüllen
                    document.getElementById("kanjiInput").value = values[0] || "";
                    document.getElementById("romajiInput").value = values[1] || "";
                    document.getElementById("kunInput").value = values[2] || "";
                    document.getElementById("onInput").value = values[3] || "";

                    // SVG befüllen
                    fillSVG();
                }

                markActiveTable();
            };

            reader.readAsArrayBuffer(file);
        }




    </script>

</body>

</html>